<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Maintenance Time Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <meta name="theme-color" content="#2e86c1" />
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body {font-family: Arial, sans-serif; max-width: 480px; margin: auto; padding: 20px; background: #f5f7fa; color: #333;}
    h2 {text-align: center;}
    #reader {width: 100%; max-width: 320px; margin: 20px auto; display: none;}
    button {padding: 12px 18px; margin: 6px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer;}
    #log {margin-top: 20px; font-size: 14px; max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ccc; padding: 8px; border-radius: 6px;}
    .primary {background: #2e86c1; color: #fff;}
    .category {background: #e67e22; color: #fff;}
    .selected {border: 2px solid #000;}
    .timestamp {color: #666; font-size: 13px; margin-left: 8px;}
  </style>
</head>
<body>
  <h2>Maintenance Time Tracker</h2>

  <div>
    <button onclick="selectType('Preventive Maintenance')" class="category">Preventive Maintenance</button>
    <button onclick="selectType('Breakdown')" class="category">Breakdown</button>
    <button onclick="selectType('Weekly Service/Mould Maintenance')" class="category">Weekly Service/Mould Maintenance</button>
  </div>

  <button id="scanBtn" class="primary" style="display:none">üì∑ Scan QR</button>
  <button onclick="clearLogs()" style="background:#dc3545; color:#fff;">üóëÔ∏è Clear Finished Logs</button>

  <div id="reader"></div>
  <div id="log"></div>

<script>
const SHEET_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwYiHlYsIzX5M2VxcPdSTpiLXeGpQGfPJaAf9vIt6xwZHIl_39VtKrLV-57dexWCegFog/exec'; // Replace with your deployed URL
let currentType = null;
let currentUser = null;
let validCells = [];
const activeSessions = JSON.parse(localStorage.getItem("activeSessions") || "{}");
const finishedLogs = JSON.parse(localStorage.getItem("finishedLogs") || "[]");

// Fetch the valid cells list from the Sheet
fetch(SHEET_WEBAPP_URL)
  .then(res => res.json())
  .then(data => {
    validCells = data.map(row => (row["QR Code"] || row["Cell Name"]).trim());
    console.log("Valid cells loaded:", validCells);
  })
  .catch(err => console.error("Failed to load cell list:", err));

function selectType(type) {
  currentType = type;
  document.querySelectorAll(".category").forEach(b => b.classList.toggle("selected", b.textContent.includes(type)));
  if (!currentUser) {
    currentUser = prompt("Please enter your name:");
    if (!currentUser) {
      alert("Name is required to proceed.");
      currentType = null;
      document.querySelectorAll(".category").forEach(b => b.classList.remove("selected"));
      return;
    }
  }
  document.getElementById("scanBtn").style.display = "inline-block";
}

const readerEl = document.getElementById("reader");
let scanner;

document.getElementById("scanBtn").onclick = () => {
  if (!currentType || !currentUser) {
    alert("Select a maintenance category and enter your name first.");
    return;
  }
  readerEl.style.display = "block";
  if (!scanner) scanner = new Html5Qrcode("reader");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    qrCodeMessage => handleScan(qrCodeMessage.trim()),
    () => {}
  ).catch(e => alert("Camera error: " + e));
};

function handleScan(cell) {
  readerEl.style.display = "none";
  scanner.stop();

  if (!validCells.includes(cell)) {
    alert(`‚ùå Unknown or unauthorized cell: ${cell}`);
    return;
  }

  if (!activeSessions[currentType]) activeSessions[currentType] = {};

  const now = new Date();

  if (activeSessions[currentType][cell]) {
    const startInfo = activeSessions[currentType][cell];
    const start = new Date(startInfo.start);
    const user = startInfo.user;
    const dur = Math.round((now - start) / 60000);
    let comment = prompt("Add a comment (optional):");
    if (!comment) comment = "N/A";

    const logEntry = {
      cell,
      type: currentType,
      user,
      start: start.toISOString(),
      end: now.toISOString(),
      durMin: dur,
      comment
    };

    finishedLogs.push(logEntry);
    delete activeSessions[currentType][cell];

    saveState();
    renderLog();

    // Send to Google Sheets using POST
    fetch(SHEET_WEBAPP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(logEntry)
    })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          console.error("Google Sheets error:", data.error);
          alert("Error logging to Google Sheets: " + data.error);
        } else {
          console.log("Logged to Google Sheets:", data);
          alert(`‚èπÔ∏è Stopped ${cell} ‚Ä¢ ${dur} min`);
        }
      })
      .catch(err => {
        console.error("Google Sheets error:", err);
        alert("Network error sending data to Google Sheets.");
      });

  } else {
    activeSessions[currentType][cell] = {
      start: now.toISOString(),
      user: currentUser
    };
    saveState();
    renderLog();
    alert(`‚ñ∂Ô∏è Started ${cell} in ${currentType}`);
  }
}

function saveState() {
  localStorage.setItem("activeSessions", JSON.stringify(activeSessions));
  localStorage.setItem("finishedLogs", JSON.stringify(finishedLogs));
}

function renderLog() {
  const div = document.getElementById("log");
  const lines = [];

  for (const [type, cells] of Object.entries(activeSessions)) {
    for (const [cell, info] of Object.entries(cells)) {
      const elapsed = Math.round((new Date() - new Date(info.start)) / 60000);
      lines.push(`‚ñ∂Ô∏è <b>${cell}</b> (${type}) by ${info.user} since ${new Date(info.start).toLocaleTimeString()} <span class="timestamp">‚Äî ${elapsed} min</span>`);
    }
  }

  finishedLogs.forEach(l => {
    lines.push(`‚èπÔ∏è <b>${l.cell}</b> (${l.type}) by ${l.user} ${l.durMin} min (${new Date(l.start).toLocaleTimeString()} ‚Äì ${new Date(l.end).toLocaleTimeString()}) ‚Äî <i>${l.comment}</i>`);
  });

  div.innerHTML = lines.length ? lines.map(x => `<div>${x}</div>`).join("") : "<em>No records yet.</em>";
}

// Remove CSV download button if present
document.getElementById("downloadBtn")?.remove();

function clearLogs() {
  if (confirm("Clear finished logs? Ongoing sessions will be kept.")) {
    localStorage.setItem("finishedLogs", JSON.stringify([]));
    renderLog();
  }
}

setInterval(renderLog, 30000);
renderLog();

// Register service worker (optional)
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js").catch(console.error);
}
</script>

</body>
</html>
