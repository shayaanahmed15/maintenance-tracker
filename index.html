<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2e86c1" />
  <link rel="icon" href="icon-192.png" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 480px; margin: auto; background: #f5f7fa; }
    button { margin: 6px; padding: 10px 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
    .primary { background: #2e86c1; color: white; }
    .category { background: #e67e22; color: white; }
    .selected { border: 2px solid black; }
    #reader { display: none; max-width: 320px; margin: 10px auto; }
    #log { font-size: 14px; margin-top: 20px; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ccc; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>Maintenance Time Tracker</h2>

  <div>
    <button class="category" onclick="selectType('Preventive Maintenance')">Preventive Maintenance</button>
    <button class="category" onclick="selectType('Breakdown')">Breakdown</button>
    <button class="category" onclick="selectType('Weekly Service/Mould Maintenance')">Weekly Service/Mould Maintenance</button>
  </div>

  <button id="scanBtn" class="primary" style="display:none">üì∑ Scan QR</button>
  <button onclick="clearLogs()" style="background:#dc3545; color:white">üóëÔ∏è Clear Logs</button>

  <div id="reader"></div>
  <div id="log"></div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqH0XukNu2hBpw4jhFRm08z9AMIeDIG3IMF7fsCTaX_3AzCcsh49Wj38HpSPZIz6R12g/exec'; // Replace with your Web App URL
let currentType = null, currentUser = null, validCells = [], scanner = null;

const readerEl = document.getElementById("reader");

fetch(`${SCRIPT_URL}?action=getValidCells`)
  .then(res => res.json())
  .then(data => {
    validCells = data.map(row => row["QR Code"] || row["Cell Name"]);
    console.log("Valid cells loaded:", validCells);
  })
  .catch(err => alert("Failed to load valid cells"));

function selectType(type) {
  currentType = type;
  document.querySelectorAll(".category").forEach(b =>
    b.classList.toggle("selected", b.textContent.includes(type))
  );

  if (!currentUser) {
    currentUser = prompt("Enter your name:");
    if (!currentUser) return;
  }

  document.getElementById("scanBtn").style.display = "inline-block";
}

document.getElementById("scanBtn").onclick = () => {
  if (!currentType || !currentUser) return alert("Choose type and enter name first");

  readerEl.style.display = "block";
  if (!scanner) scanner = new Html5Qrcode("reader");

  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    txt => handleScan(txt.trim()),
    err => console.warn(err)
  ).catch(e => alert("Camera error: " + e));
};

function handleScan(cell) {
  readerEl.style.display = "none";
  scanner.stop();

  if (!validCells.includes(cell)) return alert("Unknown cell: " + cell);

  fetch(`${SCRIPT_URL}?action=endSession&cell=${encodeURIComponent(cell)}&type=${encodeURIComponent(currentType)}&comment=${encodeURIComponent(prompt("Enter comment or issue (optional):") || "N/A")}`)
    .then(res => res.text())
    .then(text => {
      if (text.includes("No active session")) {
        // Start new session
        return fetch(`${SCRIPT_URL}?action=startSession&cell=${encodeURIComponent(cell)}&type=${encodeURIComponent(currentType)}&user=${encodeURIComponent(currentUser)}`)
          .then(r => r.text()).then(alert);
      } else {
        alert(text);
      }
    })
    .catch(err => console.error("Error:", err));
}

function clearLogs() {
  if (confirm("Clear local logs?")) document.getElementById("log").innerHTML = "<em>No logs yet.</em>";
}

if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js").catch(console.error);
</script>
</body>
</html>
